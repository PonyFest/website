<html>
	<head>
		<title>hello</title>
		{{partial "head.html" .}}
		<link href="https://vjs.zencdn.net/7.6.6/video-js.css" rel="stylesheet" />
		<style>
		body {
			margin-left: 0;
			margin-right: 0;
		}

		.main-stream {
			width: 100%;
			background-color: black;
		}

		#stream-holder {
			margin-left: auto;
			margin-right: auto;
		}

		.metadata {
			margin-left: 10px;
			margin-right: 10px;
		}

		video:focus {
			outline: none;
		}
		</style>
	</head>
	<body>
		{{partial "header.html" .}}
		<div class="main-stream">
			<div id="stream-holder">
				<video class="video-js" id="panel-stream" controls autoplay>
					<source src="{{.Params.streamURL}}" type="application/x-mpegURL">
					<p class="vjs-no-js">more js pls</p>
				</video>
			</div>
		</div>
		<div class="metadata">
			<h1 id="panel-title">PonyFest Offline!</h1>
		</div>
		<script src="https://vjs.zencdn.net/7.6.6/video.js"></script>
		<script>

		(function() {
			const now = Math.round((new Date()).getTime() / 1000);
			let player = null;
			if (now < 1585402200) {
				console.log("it's too early, waiting...")
				const timeout = (1585402200 - now) * 1000 + 60;
				document.getElementById('stream-holder').innerHTML = "<img src='/images/offline.png' style='max-width: 100%; max-height: calc(100vh - 200px); margin-left: auto; margin-right: auto; display: block;'>";
				console.log("waiting " + timeout + "ms to start");
				setTimeout(() => { location.reload(); }, timeout);
				return;
			}

			player = videojs("panel-stream", {fluid: false, crossorigin: "anonymous"});
			window.onresize = () => {
				let width = window.innerWidth;
				let height = Math.max(window.innerHeight - 200, 400);
				if (height > width / 16 * 9) {
					height = width / 16 * 9;
				} else if (width > height / 9 * 16) {
					width = height / 9 * 16;
				}
				player.height(height);
				player.width(width);
				document.getElementById('stream-holder').style.width = ''+width + 'px';
			}
			window.onresize();

			let panels = [{
				start: 0,
				title: "Pre-Con Party!"
			}, {
				start: 1585404000,
				title: "Opening Ceremonies"
			}, {
				start: 1585405800,
				title: "Artist Showcase",
			}, {
				start: 1585407600,
				title: "Copious Continuity!"
			}, {
				start: 1585411200,
				title: "Keeping Friendship Magic: The End is the Beginning"
			}, {
				start: 1585414800,
				title: "Let's build an MLP Lunchbox Guitar!",
			}, {
				start: 1585418400,
				title: "Drawing Tips & Tricks"
			}, {
				start: 1585422000,
				title: "Jackbox with the Gang!"
			}, {
				start: 1585427400,
				title: "Convention History - From WorldCon to BronyCon"
			}, {
				start: 1585432800,
				title: "Riffing Rainbow!",
			}, {
				start: 1585436400,
				title: "Peter New Power Hour!",
			}, {
				start: 1585440000,
				title: "How to Con - Behind the Scenes of Making Cons Work",
			}, {
				start: 1585443600,
				title: "IDW Artists Extravaganza"
			}, {
				start: 1585447200,
				title: "Sketches from a Hat"
			}, {
				start: 1585450800,
				title: "Big Jim's Big Panel"
			}, {
				start: 1585454400,
				title: "Concert: Lavender Harmony"
			}, {
				start: 1585458000,
				title: "Concert: Mystery performer"
			}, {
				start: 1585459800,
				title: "Concert: Faulty",
			}, {
				start: 1585461600,
				title: "Concert: 4EverfreeBrony"
			}, {
				start: 1585463400,
				title: "Concert: Francis Vace"
			}, {
				start: 1585465200,
				title: "Closing Ceremonies",
			}];

			function updateMetadata() {
				const now = Math.round((new Date()).getTime() / 1000);
				let title = "Pre-Event";
				for (let panel of panels) {
					if (now > panel.start) {
						title = panel.title;
						break;
					}
				}
				document.getElementById('panel-title').innerText = title;
			}

			player.on('error', () => {
				if (early) {
					return;
				}
				console.log("something broke! retrying in five seconds...", player.error())
				setTimeout(() => {
					console.log("retrying")
					const code = player.error().code;
			        if(code === 2 || code == 4) {
			            player.error(null);
			            player.pause();
			            player.src("{{.Params.streamURL}}");
			            player.play();
			        }
			    }, 5000);
			})
			let playing = false;
			let early = false;
			player.on('waiting', (e) => {
				if (early) {
					return;
				}
				console.log("waiting!", e);
				playing = false;
				setTimeout(() => {
					if (!playing) {
						console.log("retrying")
			            player.error(null);
			            player.pause();
			            player.src("{{.Params.streamURL}}");
			            player.play();
			        }
			    }, 5000);
			});
			player.on('playing', (e) => {
				playing = true;
				console.log('playing!');
			});
			player.on('ended', (e) => {
				console.log("stream ended! trying to start it again in five seconds...")
				setTimeout(() => {
					console.log("retrying")
		            player.error(null);
		            player.pause();
		            player.src("{{.Params.streamURL}}");
		            player.play();
			    }, 5000);
			})
			updateMetadata();
			setInterval(updateMetadata, 10000);
		})();
		</script>
	</body>
</html>
